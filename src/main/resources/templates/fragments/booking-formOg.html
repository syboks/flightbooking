<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Booking Form</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/css/style4.css}" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="#">MyApp</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
            <li class="nav-item active">
                <a class="nav-link" th:href="@{/home}">Home</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:href="@{/bookings}">Bookings</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:href="@{/customers}">Customers</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:href="@{/packages}">Packages</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:href="@{/about}">About</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:href="@{/contact}">Contact</a>
            </li>
        </ul>
    </div>
</nav>
<h1 th:text="${booking.id == null} ? 'Add New Booking' : 'Edit Booking'"></h1>

<div class="container">
<form th:action="@{/bookings/save}" th:object="${booking}" method="post">
    <input type="hidden" th:field="*{id}" />
    <input type="hidden" th:field="*{customer.id}" />

    <div class="row">
        <div class="col-md-4">
            <label for="package">Package:</label>
            <select id="package" th:field="*{pkg.id}" required>
                <option value="" disabled selected>Select Package</option>
                <option th:each="pkg : ${packages}"
                        th:value="${pkg.id}"
                        th:text="${pkg.name}">
                </option>
            </select>
        </div>
        <div class="col-md-4">
            <label for="price">Price:</label>
            <input type="number" id="price1" th:field="*{price}" readonly />
        </div>
        <div class="col-md-4">
            <label for="totalPaid">Total Paid:</label>
            <input type="number" id="totalPaid" th:field="*{totalPaid}" required />
        </div>
    </div>
    <div class="row">
        <div class="col-md-4">
            <label for="departure">Departure:</label>
            <input type="text" id="departure" th:field="*{departure}" required />
        </div>

        <div class="col-md-4">
            <label for="destination">Destination:</label>
            <input type="text" id="destination" th:field="*{destination}" required />
        </div>
        <div class="col-md-4">
            <label for="departureDate">Travel Date:</label>
            <input type="date" id="departureDate" th:field="*{departureDate}" required />
        </div>

    </div>
    <div class="row">
        <div class="col-md-4">
            <label for="arrivalDate">Payment Deadline Date:</label>
            <input type="date" id="arrivalDate" th:field="*{arrivalDate}"  />
        </div>

        <div class="col-md-4">
            <label for="airline">Platform:</label>
            <input type="text" id="airline" th:field="*{airline}" required />
        </div>

        <div class="col-md-4">
            <label for="salesRep">Sales Rep:</label>
            <input type="text" id="salesRep" th:field="*{salesRep}" required />
        </div>
    </div>
    <div class="row">
        <div class="col-md-6">
            <div class="dropdown-container">
                <div>
                    <label for="adults">Adults:</label>
                    <select id="numAdults" th:field="*{numAdults}">
                        <option value="1">1</option>
                        <option value="2" selected>2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>

                <div>
                    <label for="children">Children:</label>
                    <select id="numChildren" th:field="*{numChildren}">
                        <option value="0" selected>0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>

                <div>
                    <label for="infants">Infants:</label>
                    <select id="numInfants" th:field="*{numInfants}">
                        <option value="0" selected>0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                    </select>
                </div>
            </div>
         </div>
        <div class="col-md-3">
            <label for="refNumber">Reference Number:</label>
            <input type="text" id="refNumber" th:field="*{refNumber}" required />
        </div>
        <div class="col-md-3">
        <label for="paymentStatus">Payment Status:</label>
        <select id="paymentStatus" th:field="*{paymentStatus}" required>
            <option value="UNPAID">Unpaid</option>
            <option value="PARTIALLY_PAID">Partially Paid</option>
            <option value="PAID">Paid</option>
        </select>
    </div>
    </div>
    <h3>Products</h3>
    <button type="button" id="addProduct">Add Product</button>
    <div id="productList">
        <div th:each="product, iterStat : ${booking.products}">
            <div class="row">
                <div class="col-md-3">
                    <label>Product:</label>
                    <input type="text" th:field="*{products[__${iterStat.index}__].productName}" required/>
                </div>
                <div class="col-md-2">
                    <label>Price:</label>
                    <input type="number" step="0.01" th:field="*{products[__${iterStat.index}__].price}" class="product-price" required />
                </div>
                <div class="col-md-2">
                    <label>Start Date:</label>
                    <input type="date" th:field="*{products[__${iterStat.index}__].startDate}" required/>
                </div>
                <div class="col-md-2">
                    <label>Number of Days:</label>
                    <input type="number" th:field="*{products[__${iterStat.index}__].numDays}" required/>
                </div>
                <div class="col-md-3">
                    <label>Action:</label>
                    <button type="button" th:onclick="'removeProduct(this)'" class="remove-product">Remove</button>
                </div>
            </div>

        </div>

    </div>
    <div class="row">
        <div class="col-md-3">
            <label for="total">Total:</label>
            <input type="number" id="total" readonly />
        </div>
    </div>



    <div class="row">
        <div class="col-md-3">
            <button type="submit">Save</button>
        </div>
        <div class="col-md-3">
<!--            <a th:href="@{/bookings/makePayment(id=${booking.id})}" class="btn btn-success" th:if="${booking.id != null}">Make Payment</a>-->
        </div>
    </div>



</form>
</div>
<a th:href="@{/bookings}">Cancel</a>

<script>
    $(document).ready(function () {
        let productIndex = [[${#lists.size(booking.products)}]];

        $('#addProduct').click(function () {
            let productForm = `
                <div class="row">
                    <div class="col-md-3">
                         <input type="text" name="products[${productIndex}].productName" required/>
                     </div>
                      <div class="col-md-2">
                        <input type="number" step="0.01" name="products[${productIndex}].price" class="product-price" required/>
                      </div>
                      <div class="col-md-2">
                        <input type="date"  name="products[${productIndex}].startDate"  required/>
                      </div>
                      <div class="col-md-2">
                        <input type="number"  name="products[${productIndex}].numDays"  required/>
                      </div>
                      <div class="col-md-3">
                            <label>Action:</label>
                            <button type="button" onclick="removeProduct(this)" class="remove-product">Remove</button>
                      </div>

                </div>`;
            $('#productList').append(productForm);
            productIndex++;
            updateTotal();
        });
        $('#productList').on('input', '.product-price', function() {
            updateTotal();  // Update total when a product price changes
        });
    });

    function removeProduct(button) {
        $(button).closest('.row').remove();
        updateTotal(); // Recalculate the to
    }
    function updateTotal() {
        let total = 0;
        $('.product-price').each(function() {
            let price = parseFloat($(this).val());
            if (!isNaN(price)) {
                total += price;
            }
        });
        $('#total').val(total.toFixed(2));
        $('#price1').val(total.toFixed(2));  // Update the hidden pricex field
    }
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let priceField = document.getElementById('price');
        let departureDateField = document.getElementById('departureDate');
        let arrivalDateField = document.getElementById('arrivalDate');

        if (!priceField || !departureDateField || !arrivalDateField) {
            console.error('Price, Departure Date, or Arrival Date field not found!');
            return;
        }

        document.getElementById('package').addEventListener('change', function() {
            let pkgId = this.value;
            if (pkgId) {
                fetch('/packages/' + pkgId)
                    .then(response => response.json())
                    .then(pkg => {
                        // Set the price field value
                        priceField.value = pkg.price;

                        // Set min and max for the departureDate and arrivalDate fields
                        if (pkg.startDate && pkg.endDate) {
                            departureDateField.min = pkg.startDate;
                            departureDateField.max = pkg.endDate;

                            arrivalDateField.min = pkg.startDate;
                            arrivalDateField.max = pkg.endDate;
                        } else {
                            departureDateField.min = '';
                            departureDateField.max = '';

                            arrivalDateField.min = '';
                            arrivalDateField.max = '';
                        }
                    });
            } else {
                priceField.value = '';
                departureDateField.min = '';
                departureDateField.max = '';

                arrivalDateField.min = '';
                arrivalDateField.max = '';
            }
        });
    });
</script>
<script>
    document.getElementById('departureDate').addEventListener('change', function() {
        const departureDate = new Date(this.value);
        if (!isNaN(departureDate.getTime())) {
            // Subtract 45 days from the departure date
            departureDate.setDate(departureDate.getDate() - 45);

            // Format the date to yyyy-mm-dd
            const formattedDate = departureDate.toISOString().split('T')[0];

            // Set the arrivalDate input value
            document.getElementById('arrivalDate').value = formattedDate;
        }
    });
</script>

</body>
</html>
